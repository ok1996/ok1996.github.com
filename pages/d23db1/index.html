<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>K8S-CICD | 北山小库</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/20230310/logo.3mn8xlqm9oy0.webp">
    <meta name="description" content="小渔村的板砖师傅">
    <meta name="keywords" content="小渔村的板砖师傅">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.b5b3c98c.css" as="style"><link rel="preload" href="/assets/js/app.68b6bd65.js" as="script"><link rel="preload" href="/assets/js/4.b460a2fa.js" as="script"><link rel="preload" href="/assets/js/6.d822d7aa.js" as="script"><link rel="preload" href="/assets/js/3.1b6344a7.js" as="script"><link rel="prefetch" href="/assets/js/10.bfd263f5.js"><link rel="prefetch" href="/assets/js/100.7b445cd4.js"><link rel="prefetch" href="/assets/js/101.1b83670b.js"><link rel="prefetch" href="/assets/js/102.88d1f235.js"><link rel="prefetch" href="/assets/js/103.35da5376.js"><link rel="prefetch" href="/assets/js/104.02d13855.js"><link rel="prefetch" href="/assets/js/105.bf6934a9.js"><link rel="prefetch" href="/assets/js/106.a25509d9.js"><link rel="prefetch" href="/assets/js/107.76d65fdc.js"><link rel="prefetch" href="/assets/js/108.841a6f5f.js"><link rel="prefetch" href="/assets/js/109.618fddf3.js"><link rel="prefetch" href="/assets/js/11.a2cb240c.js"><link rel="prefetch" href="/assets/js/110.e7f49675.js"><link rel="prefetch" href="/assets/js/111.b2320a15.js"><link rel="prefetch" href="/assets/js/112.d8615c60.js"><link rel="prefetch" href="/assets/js/113.555b5ceb.js"><link rel="prefetch" href="/assets/js/114.6bf16e72.js"><link rel="prefetch" href="/assets/js/115.87b78f2b.js"><link rel="prefetch" href="/assets/js/116.12e9c0ca.js"><link rel="prefetch" href="/assets/js/117.68a1e2d3.js"><link rel="prefetch" href="/assets/js/118.8bedaf30.js"><link rel="prefetch" href="/assets/js/119.ebdaa201.js"><link rel="prefetch" href="/assets/js/12.d6489e5a.js"><link rel="prefetch" href="/assets/js/120.6de62b28.js"><link rel="prefetch" href="/assets/js/121.aa717da3.js"><link rel="prefetch" href="/assets/js/122.af3032d9.js"><link rel="prefetch" href="/assets/js/123.5b942c99.js"><link rel="prefetch" href="/assets/js/124.43e025f7.js"><link rel="prefetch" href="/assets/js/125.45e63154.js"><link rel="prefetch" href="/assets/js/126.bf25c59a.js"><link rel="prefetch" href="/assets/js/127.b44c98e3.js"><link rel="prefetch" href="/assets/js/128.1f3f7248.js"><link rel="prefetch" href="/assets/js/129.c4de3bbc.js"><link rel="prefetch" href="/assets/js/13.ac397c31.js"><link rel="prefetch" href="/assets/js/130.eafab6ac.js"><link rel="prefetch" href="/assets/js/131.7d00aab7.js"><link rel="prefetch" href="/assets/js/132.7d2c8b2a.js"><link rel="prefetch" href="/assets/js/133.07e83312.js"><link rel="prefetch" href="/assets/js/134.34c9ad3b.js"><link rel="prefetch" href="/assets/js/135.ff2d29fe.js"><link rel="prefetch" href="/assets/js/136.38967598.js"><link rel="prefetch" href="/assets/js/137.9f55cdca.js"><link rel="prefetch" href="/assets/js/138.546d3c93.js"><link rel="prefetch" href="/assets/js/139.0765fc2c.js"><link rel="prefetch" href="/assets/js/14.ea9a7ff6.js"><link rel="prefetch" href="/assets/js/140.2c809947.js"><link rel="prefetch" href="/assets/js/141.1f779c1f.js"><link rel="prefetch" href="/assets/js/142.321289b4.js"><link rel="prefetch" href="/assets/js/143.fb5265d0.js"><link rel="prefetch" href="/assets/js/144.01044169.js"><link rel="prefetch" href="/assets/js/145.57a3dc92.js"><link rel="prefetch" href="/assets/js/146.0cddfbc1.js"><link rel="prefetch" href="/assets/js/147.2c2be098.js"><link rel="prefetch" href="/assets/js/148.21a1bb6d.js"><link rel="prefetch" href="/assets/js/149.282f5f7b.js"><link rel="prefetch" href="/assets/js/15.e2cc67bb.js"><link rel="prefetch" href="/assets/js/150.a02b58e6.js"><link rel="prefetch" href="/assets/js/16.737732d0.js"><link rel="prefetch" href="/assets/js/17.29472bc1.js"><link rel="prefetch" href="/assets/js/18.19ce1850.js"><link rel="prefetch" href="/assets/js/19.6f1c1b29.js"><link rel="prefetch" href="/assets/js/2.6b8046f1.js"><link rel="prefetch" href="/assets/js/20.d339520e.js"><link rel="prefetch" href="/assets/js/21.453d697e.js"><link rel="prefetch" href="/assets/js/22.816006ba.js"><link rel="prefetch" href="/assets/js/23.6051f07c.js"><link rel="prefetch" href="/assets/js/24.51e833e5.js"><link rel="prefetch" href="/assets/js/25.bf812edb.js"><link rel="prefetch" href="/assets/js/26.3786989c.js"><link rel="prefetch" href="/assets/js/27.ebabd368.js"><link rel="prefetch" href="/assets/js/28.6c32fbf7.js"><link rel="prefetch" href="/assets/js/29.a387bc71.js"><link rel="prefetch" href="/assets/js/30.5d61719a.js"><link rel="prefetch" href="/assets/js/31.813a3d54.js"><link rel="prefetch" href="/assets/js/32.96fe870d.js"><link rel="prefetch" href="/assets/js/33.a266b26b.js"><link rel="prefetch" href="/assets/js/34.acb9d5ed.js"><link rel="prefetch" href="/assets/js/35.76c75051.js"><link rel="prefetch" href="/assets/js/36.eb5f8a0d.js"><link rel="prefetch" href="/assets/js/37.173830f7.js"><link rel="prefetch" href="/assets/js/38.b645eb26.js"><link rel="prefetch" href="/assets/js/39.a4866f83.js"><link rel="prefetch" href="/assets/js/40.fd485c5c.js"><link rel="prefetch" href="/assets/js/41.47d217c1.js"><link rel="prefetch" href="/assets/js/42.c6c1cc6a.js"><link rel="prefetch" href="/assets/js/43.0eddffb6.js"><link rel="prefetch" href="/assets/js/44.c469e909.js"><link rel="prefetch" href="/assets/js/45.6e4d6bf8.js"><link rel="prefetch" href="/assets/js/46.392741de.js"><link rel="prefetch" href="/assets/js/47.9fa5bdc5.js"><link rel="prefetch" href="/assets/js/48.078b413b.js"><link rel="prefetch" href="/assets/js/49.fbc7c1b9.js"><link rel="prefetch" href="/assets/js/5.56abc43d.js"><link rel="prefetch" href="/assets/js/50.bf2ebb23.js"><link rel="prefetch" href="/assets/js/51.aa2d8f43.js"><link rel="prefetch" href="/assets/js/52.f331a434.js"><link rel="prefetch" href="/assets/js/53.4ce14868.js"><link rel="prefetch" href="/assets/js/54.69ebfeb1.js"><link rel="prefetch" href="/assets/js/55.65cb54bf.js"><link rel="prefetch" href="/assets/js/56.3ce62a4c.js"><link rel="prefetch" href="/assets/js/57.e869d56c.js"><link rel="prefetch" href="/assets/js/58.b02c1aae.js"><link rel="prefetch" href="/assets/js/59.37e2327a.js"><link rel="prefetch" href="/assets/js/60.1120e748.js"><link rel="prefetch" href="/assets/js/61.0ce226fa.js"><link rel="prefetch" href="/assets/js/62.e1849ecf.js"><link rel="prefetch" href="/assets/js/63.6b9e1607.js"><link rel="prefetch" href="/assets/js/64.e3ed9c44.js"><link rel="prefetch" href="/assets/js/65.9a73e314.js"><link rel="prefetch" href="/assets/js/66.a0a7fadf.js"><link rel="prefetch" href="/assets/js/67.f34b25dd.js"><link rel="prefetch" href="/assets/js/68.2b3c775f.js"><link rel="prefetch" href="/assets/js/69.a520273a.js"><link rel="prefetch" href="/assets/js/7.2f4f5bcd.js"><link rel="prefetch" href="/assets/js/70.0da250dd.js"><link rel="prefetch" href="/assets/js/71.9c01e143.js"><link rel="prefetch" href="/assets/js/72.ee6fd019.js"><link rel="prefetch" href="/assets/js/73.60f17bdc.js"><link rel="prefetch" href="/assets/js/74.ebd9bc95.js"><link rel="prefetch" href="/assets/js/75.870c5c30.js"><link rel="prefetch" href="/assets/js/76.2a4906cf.js"><link rel="prefetch" href="/assets/js/77.06f7e294.js"><link rel="prefetch" href="/assets/js/78.28d96cfa.js"><link rel="prefetch" href="/assets/js/79.a16e8eaf.js"><link rel="prefetch" href="/assets/js/8.09ab7939.js"><link rel="prefetch" href="/assets/js/80.1dbfe412.js"><link rel="prefetch" href="/assets/js/81.013f1ef4.js"><link rel="prefetch" href="/assets/js/82.17bad2ad.js"><link rel="prefetch" href="/assets/js/83.37171995.js"><link rel="prefetch" href="/assets/js/84.e2375b66.js"><link rel="prefetch" href="/assets/js/85.03bfb4d3.js"><link rel="prefetch" href="/assets/js/86.ecd0f721.js"><link rel="prefetch" href="/assets/js/87.70d32677.js"><link rel="prefetch" href="/assets/js/88.cd1c65b9.js"><link rel="prefetch" href="/assets/js/89.61dfe641.js"><link rel="prefetch" href="/assets/js/9.eeae5d81.js"><link rel="prefetch" href="/assets/js/90.7488e157.js"><link rel="prefetch" href="/assets/js/91.4d539e6f.js"><link rel="prefetch" href="/assets/js/92.a4c6ee1e.js"><link rel="prefetch" href="/assets/js/93.71ef2792.js"><link rel="prefetch" href="/assets/js/94.25f99807.js"><link rel="prefetch" href="/assets/js/95.b79a71bf.js"><link rel="prefetch" href="/assets/js/96.c2042ef9.js"><link rel="prefetch" href="/assets/js/97.0708dc08.js"><link rel="prefetch" href="/assets/js/98.22040657.js"><link rel="prefetch" href="/assets/js/99.edbbf1c2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b5b3c98c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><!----> <span class="title" style="display:;">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8e9dc3400/" class="nav-link">2023.4.0.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3410/" class="nav-link">2023.4.1.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3500/" class="nav-link">2023.5.0.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3p510/" class="nav-link">2023.5.1.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3p520/" class="nav-link">2023.5.2.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3p24100/" class="nav-link">2024.1.0.0-SNAPSHOT</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><!----> <span class="title" style="display:;">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/note/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/note/deploy/" class="nav-link">Deploy</a></li><li class="dropdown-item"><!----> <a href="/note/application/" class="nav-link">Application</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div> <a href="https://github.com/ok1996" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/20230310/logo.3mn8xlqm9oy0.webp"> <div class="blogger-info"><h3>Xiao ku</h3> <span>板砖师傅</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><!----> <span class="title" style="display:;">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8e9dc3400/" class="nav-link">2023.4.0.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3410/" class="nav-link">2023.4.1.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3500/" class="nav-link">2023.5.0.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3p510/" class="nav-link">2023.5.1.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3p520/" class="nav-link">2023.5.2.0</a></li><li class="dropdown-item"><!----> <a href="/pages/8e9dc3p24100/" class="nav-link">2024.1.0.0-SNAPSHOT</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分类" class="dropdown-title"><!----> <span class="title" style="display:;">技术分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/note/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/note/deploy/" class="nav-link">Deploy</a></li><li class="dropdown-item"><!----> <a href="/note/application/" class="nav-link">Application</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friends/" class="nav-link">友情链接</a></div> <a href="https://github.com/ok1996" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/74ea91/" class="sidebar-link">Docker一键部署</a></li><li><a href="/pages/d04772/" class="sidebar-link">Mysql主从配置一键化</a></li><li><a href="/pages/b6e922/" class="sidebar-link">Mysql新建主从同步-mysqldump</a></li><li><a href="/pages/3c702b/" class="sidebar-link">SkyWalking部署及使用</a></li><li><a href="/pages/bb3405/" class="sidebar-link">Prometheus部署及使用</a></li><li><a href="/pages/d23db1/" aria-current="page" class="active sidebar-link">K8S-CICD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#架构" class="sidebar-link">架构</a></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#部署k8s" class="sidebar-link">部署K8S</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#部署包" class="sidebar-link">部署包</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#部署步骤" class="sidebar-link">部署步骤</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#安装master-201" class="sidebar-link">安装Master（201）</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#安装worker-202" class="sidebar-link">安装Worker（202）</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#安装worker-203" class="sidebar-link">安装Worker（203）</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#完成" class="sidebar-link">完成</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#访问kuboard" class="sidebar-link">访问Kuboard</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#获取登陆token" class="sidebar-link">获取登陆Token</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#访问kubernetes-dashboard" class="sidebar-link">访问Kubernetes Dashboard</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#部署nfs" class="sidebar-link">部署NFS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#部署" class="sidebar-link">部署</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#_203服务端配置" class="sidebar-link">203服务端配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#_201客户端测试" class="sidebar-link">201客户端测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#部署harbor" class="sidebar-link">部署Harbor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#安装docker" class="sidebar-link">安装docker</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#安装harbor" class="sidebar-link">安装harbor</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#上传" class="sidebar-link">上传</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#解压" class="sidebar-link">解压</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#新建文件harbor-yml" class="sidebar-link">新建文件harbor.yml</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#启动成功" class="sidebar-link">启动成功</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#部署gitlab" class="sidebar-link">部署GitLab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#内存问题" class="sidebar-link">内存问题</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#部署jenkins" class="sidebar-link">部署Jenkins</a></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#docker配置harbor" class="sidebar-link">Docker配置Harbor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#修改docker-service" class="sidebar-link">修改docker.service</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#重启docker" class="sidebar-link">重启docker</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#登录docker" class="sidebar-link">登录docker</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#上传镜像" class="sidebar-link">上传镜像</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#初始化jenkins" class="sidebar-link">初始化Jenkins</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#安装推荐的插件及账号" class="sidebar-link">安装推荐的插件及账号</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#安装其他插件" class="sidebar-link">安装其他插件</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#初始化harbor" class="sidebar-link">初始化Harbor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#创建用户" class="sidebar-link">创建用户</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#创建项目" class="sidebar-link">创建项目</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#增加成员" class="sidebar-link">增加成员</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#初始化gitlab" class="sidebar-link">初始化GitLab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#创建账号" class="sidebar-link">创建账号</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#初始化密码" class="sidebar-link">初始化密码</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#登录" class="sidebar-link">登录</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#初始化项目" class="sidebar-link">初始化项目</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#创建空项目" class="sidebar-link">创建空项目</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#创建dev分支" class="sidebar-link">创建dev分支</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#提交项目代码" class="sidebar-link">提交项目代码</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#jenkins配置k8s" class="sidebar-link">Jenkins配置K8S</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#配置插件" class="sidebar-link">配置插件</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#k8s集群信息" class="sidebar-link">k8s集群信息</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#创建admin证书" class="sidebar-link">创建admin证书</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#安装证书工具" class="sidebar-link">安装证书工具</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#准备证书签名请求" class="sidebar-link">准备证书签名请求</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#创建证书和私钥" class="sidebar-link">创建证书和私钥</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#配置证书" class="sidebar-link">配置证书</a></li><li class="sidebar-sub-header level5"><a href="/pages/d23db1/#生成pkc格式证书" class="sidebar-link">生成pkc格式证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#配置jenkins认证" class="sidebar-link">配置jenkins认证</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#kubernetes-服务证书-key" class="sidebar-link">Kubernetes 服务证书 key</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#gitlab-jenkins配置" class="sidebar-link">GitLab+Jenkins配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#gitlab与jenkins配置" class="sidebar-link">GitLab与Jenkins配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#设置jenkins-用户ssh秘钥" class="sidebar-link">设置jenkins 用户ssh秘钥</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#创建access-tokens" class="sidebar-link">创建Access Tokens</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#jenkins配置git-gitlab" class="sidebar-link">Jenkins配置Git/GitLab</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#jenkins配置gitlab" class="sidebar-link">Jenkins配置GitLab</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#jenkins配置git" class="sidebar-link">Jenkins配置Git</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#创建一个jenkins-job" class="sidebar-link">创建一个Jenkins Job</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#配置job的源码管理" class="sidebar-link">配置Job的源码管理</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#配置job的构建触发器" class="sidebar-link">配置Job的构建触发器</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#配置job的构建脚本" class="sidebar-link">配置Job的构建脚本</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#jenkins配置maven" class="sidebar-link">Jenkins配置maven</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#查看java和maven安装地址" class="sidebar-link">查看java和maven安装地址</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#新增jdk" class="sidebar-link">新增JDK</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#新增maven" class="sidebar-link">新增Maven</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#jenkins使用docker命令" class="sidebar-link">Jenkins使用docker命令</a></li><li class="sidebar-sub-header level2"><a href="/pages/d23db1/#jenkins-harbor-gitlab-k8s" class="sidebar-link">Jenkins+Harbor+GitLab+K8S</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#方式一" class="sidebar-link">方式一</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#k8s创建命名空间" class="sidebar-link">K8S创建命名空间</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#k8s创建harbor密码信息" class="sidebar-link">K8S创建Harbor密码信息</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#工程新建脚本" class="sidebar-link">工程新建脚本</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#jenkins创建任务" class="sidebar-link">Jenkins创建任务</a></li><li class="sidebar-sub-header level3"><a href="/pages/d23db1/#方式二" class="sidebar-link">方式二</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#k8s创建命名空间-2" class="sidebar-link">K8S创建命名空间</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#k8s创建harbor密码信息-2" class="sidebar-link">K8S创建Harbor密码信息</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#工程新建脚本-2" class="sidebar-link">工程新建脚本</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#jenkins创建任务-2" class="sidebar-link">Jenkins创建任务</a></li><li class="sidebar-sub-header level4"><a href="/pages/d23db1/#k8s创建pod" class="sidebar-link">K8S创建Pod</a></li></ul></li></ul></li><li><a href="/pages/c5c5bb/" class="sidebar-link">K8S-在线安装</a></li><li><a href="/pages/04f4f5/" class="sidebar-link">K3S-在线安装</a></li><li><a href="/pages/de1358/" class="sidebar-link">K3S-CICD</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/note/deploy/#Deploy" data-v-06970110>Deploy</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/ok1996" target="_blank" title="作者" class="beLink" data-v-06970110>xiaoku</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-03-13</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">K8S-CICD<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="架构"><a href="#架构" class="header-anchor">#</a> 架构</h2> <p><img src="/assets/img/image-27-1024x336.1ee8af05.png" alt=""></p> <p>流程图</p> <p><img src="/assets/img/image-69-1024x413.6933e94c.png" alt=""></p> <h2 id="部署k8s"><a href="#部署k8s" class="header-anchor">#</a> 部署K8S</h2> <p>半离线部署</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>系统版本：CentOS Linux release 7.9.2009 (Core)  
Kubernetes：1.17.1  
Docker：18.06.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="部署包"><a href="#部署包" class="header-anchor">#</a> 部署包</h3> <p>地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>链接：https://pan.baidu.com/s/1pMiSfbz48ZQSwmPGC43RQA 
提取码：xnh3 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="部署步骤"><a href="#部署步骤" class="header-anchor">#</a> 部署步骤</h3> <h4 id="安装master-201"><a href="#安装master-201" class="header-anchor">#</a> 安装Master（201）</h4> <p>在master节点上执行。<br>
上传k8sOfflineSetup20210720.zip文件到root目录下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>scp k8sOfflineSetup20210720.zip root@192.168.213.201:/root
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>解压到/root（解压路径不能修改）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>unzip k8sOfflineSetup20210720.zip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置参数并安装</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># master节点的主机名
export HOSTNAME=k8s-master
# kubernetes apiserver的主机地址
export APISERVER_NAME=apiserver.k8s.com
# 集群中master节点的ip地址
export MASTER_IP=192.168.213.201
# Pod 使用的网段
export POD_SUBNET=10.11.10.0/16

cd /root/k8sOfflineSetup
./setup_master.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="/assets/img/image-16.53b8c1a1.png" alt=""></p> <p><img src="/assets/img/image-17-854x1024.ff9da00a.png" alt=""></p> <h4 id="安装worker-202"><a href="#安装worker-202" class="header-anchor">#</a> 安装Worker（202）</h4> <p>在worker节点上执行。<br>
上传k8sOfflineSetup20210720.zip文件到root目录下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>scp k8sOfflineSetup20210720.zip root@192.168.213.202:/root
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>解压到/root（解压路径不能修改）</p> <p>unzip k8sOfflineSetup20210720.zip</p> <p>获取加入master的参数（是在master节点上执行。）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 在 master 节点执行
kubeadm token create --print-join-command

# 得到token和cert，这两个参数在2个小时内可以重复使用，超过以后就得再次生成
kubeadm join apiserver.k8s.com:6443 --token t8rn2w.zwfd42edrro02c50     --discovery-token-ca-cert-hash sha256:fe343cc72e449988acf789ba1c47fe83c7f80534fb7e0770f1fbe9b3facdbadb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/assets/img/image-18-1024x63.b436638b.png" alt=""></p> <p>设置参数并安装<br>
在worker节点上执行。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># worker节点的主机名
export HOSTNAME=k8s-worker202
# kubernetes apiserver的主机地址
export APISERVER_NAME=apiserver.k8s.com
# 集群中master节点的ip地址
export MASTER_IP=192.168.213.201
# 加入master的token
export TOKEN=t8rn2w.zwfd42edrro02c50
# 加入master的证书
export export CERT=sha256:fe343cc72e449988acf789ba1c47fe83c7f80534fb7e0770f1fbe9b3facdbadb
cd /root/k8sOfflineSetup
./setup_worker.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/assets/img/image-19.2032f737.png" alt=""></p> <h4 id="安装worker-203"><a href="#安装worker-203" class="header-anchor">#</a> 安装Worker（203）</h4> <p>在worker节点上执行。<br>
上传k8sOfflineSetup20210720.zip文件到root目录下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>scp k8sOfflineSetup20210720.zip root@192.168.213.203:/root
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>解压到/root（解压路径不能修改）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>unzip k8sOfflineSetup20210720.zip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置参数并安装（token之类已获得，一样便可）<br>
在worker节点上执行。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># worker节点的主机名
export HOSTNAME=k8s-worker203
# kubernetes apiserver的主机地址
export APISERVER_NAME=apiserver.k8s.com
# 集群中master节点的ip地址
export MASTER_IP=192.168.213.201
# 加入master的token
export TOKEN=t8rn2w.zwfd42edrro02c50
# 加入master的证书
export export CERT=sha256:fe343cc72e449988acf789ba1c47fe83c7f80534fb7e0770f1fbe9b3facdbadb
cd /root/k8sOfflineSetup
./setup_worker.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/assets/img/image-20.2df47382.png" alt=""></p> <h4 id="完成"><a href="#完成" class="header-anchor">#</a> 完成</h4> <p>现在你可以在master节点，执行kubectl get nodes看到所有节点都在线了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image-21.8ce36337.png" alt=""></p> <h3 id="访问kuboard"><a href="#访问kuboard" class="header-anchor">#</a> 访问Kuboard</h3> <p>Kuboard是一个非常方便的web管理界面，安装完以后可以通过http://任意节点IP:32567/访问。<br>
详细使用请参考 <a href="http://www.kuboard.cn" target="_blank" rel="noopener noreferrer">www.kuboard.cn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/assets/img/image-22-1024x351.249ac26e.png" alt=""></p> <h3 id="获取登陆token"><a href="#获取登陆token" class="header-anchor">#</a> 获取登陆Token</h3> <p>在 Master 节点上执行此命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk '{print $1}') -o go-template='{{.data.token}}' | base64 -d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="访问kubernetes-dashboard"><a href="#访问kubernetes-dashboard" class="header-anchor">#</a> 访问Kubernetes Dashboard</h3> <h2 id="部署nfs"><a href="#部署nfs" class="header-anchor">#</a> 部署NFS</h2> <p>服务端IP：192.168.213.203</p> <p>服务点目录：/data/share</p> <h3 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h3> <p>因为每台K8S都可能需要使用到挂载，故每台都需要安装</p> <p>（192.168.213.201-203）</p> <p>安装命令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yum -y install nfs-utils  rpcbind 

# nfs 启动
# 为rpcbind和nfs做开机启动
systemctl enable rpcbind.service
systemctl enable nfs-server.service

#启动相关软件
systemctl start rpcbind.service
systemctl start nfs-server.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_203服务端配置"><a href="#_203服务端配置" class="header-anchor">#</a> 203服务端配置</h3> <p>创建共享文件夹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /data/share
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>nfs 配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>vi /etc/exports
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改配置文件，增加下面这一行数据，指定的ip地址为客户端的地址,地址可以是一个网段（如：192.168.0.0/24）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/data/share 192.168.213.0/24(rw,no_root_squash,no_all_squash,sync)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>加载配置文件，在相关软件启动后执行</p> <p>exportfs -arv</p> <p><img src="/assets/img/image-24-1024x153.a5c20fbd.png" alt=""></p> <h3 id="_201客户端测试"><a href="#_201客户端测试" class="header-anchor">#</a> 201客户端测试</h3> <p>创建共享文件夹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir -p /home/nfs_share
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在你的 NFS 服务器设定妥当之后，我们可以在 client端先自我测试一下是否可以联机喔！利用 showmount 这个指令来查阅！</p> <p>如果报：clnt_create: RPC: Port mapper failure - Unable to receive: errno 113 (No route to host)，可能防火墙没关</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>showmount -e 192.168.213.203
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>挂载测试</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mount -t nfs 192.168.213.203:/data/share /home/nfs_share 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看挂载情况，可以使用这个命令df -TH</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>df -TH
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>卸载</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>umount /home/nfs_share
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="部署harbor"><a href="#部署harbor" class="header-anchor">#</a> 部署Harbor</h2> <p>部署包官方地址：https://github.com/goharbor/harbor/releases</p> <p>个人下载地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>链接：https://pan.baidu.com/s/1kmEPizetpsoF82FRdH3I9w 
提取码：a4nh 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>IP：192.168.213.204<br>
账号：admin<br>
密码：Harbor12345<br>
访问地址：http://192.168.213.204:20480</p> <h3 id="安装docker"><a href="#安装docker" class="header-anchor">#</a> 安装docker</h3> <p>安装docker及docker-compose</p> <h3 id="安装harbor"><a href="#安装harbor" class="header-anchor">#</a> 安装harbor</h3> <h4 id="上传"><a href="#上传" class="header-anchor">#</a> 上传</h4> <p>上传harbor-offline-installer-v2.2.3.tgz文件到/data目录</p> <h4 id="解压"><a href="#解压" class="header-anchor">#</a> 解压</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>tar xzvf  harbor-offline-installer-v2.2.3.tgz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="新建文件harbor-yml"><a href="#新建文件harbor-yml" class="header-anchor">#</a> 新建文件harbor.yml</h4> <p>内容复制harbor.yml.tmpl<br>
修改 hostname: 192.168.213.204 为本机IP<br>
端口<br>
修改数据存储地址/data/harbor/data<br>
注释https</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd /data/harbor
vi harbor.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>harbor.yml</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>hostname: 192.168.213.204 

http:
  port: 20480

harbor_admin_password: Harbor12345

database:
  password: root123
  max_idle_conns: 50
  max_open_conns: 1000

data_volume: /data/harbor/data

trivy:
  ignore_unfixed: false
  skip_update: false
  insecure: false

jobservice:
  max_job_workers: 10

notification:
  webhook_job_max_retry: 10

chart:
  absolute_url: disabled

log:
  level: info
  local:
    rotate_count: 50
    rotate_size: 200M
    location: /var/log/harbor
_version: 2.2.0

proxy:
  http_proxy:
  https_proxy:
  no_proxy:
  components:
    - core
    - jobservice
    - trivy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h4> <p>./install.sh</p> <h4 id="启动成功"><a href="#启动成功" class="header-anchor">#</a> 启动成功</h4> <p>查看一下<br>
docker-compose ps</p> <h2 id="部署gitlab"><a href="#部署gitlab" class="header-anchor">#</a> 部署GitLab</h2> <p>使用docker-compose.yml便可</p> <p>页面访问地址：http://192.168.213.204:8929</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: '3'
services:
  gitlab:
    image: 'gitlab/gitlab-ce:14.0.6-ce.0'
    container_name: gitlab
    restart: always
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://192.168.213.204:8929' #若有域名可以写域名
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
    ports:
      - '8929:8929'
      - '2224:22'
    volumes:
      #将相关配置映射到当前目录下的config目录
      - './config:/etc/gitlab'
      #将日志映射到当前目录下的logs目录
      - './logs:/var/log/gitlab'
      #将数据映射到当前目录下的data目录
      - './data:/var/opt/gitlab'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>登录账号：root</p> <p>登录密码：在服务启动后，查看config/initial_root_password文件</p> <p>限制内存及时区</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://106.55.159.125:8929' #若有域名可以写域名
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
        puma['per_worker_max_memory_mb'] = 1024 #更改内存限制设置
        gitlab_rails['time_zone'] = 'Asia/Shanghai'
        puma['worker_processes'] = 2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>参考文档：https://docs.gitlab.com/ee/administration/operations/puma.html</p> <h3 id="内存问题"><a href="#内存问题" class="header-anchor">#</a> 内存问题</h3> <p>如果使用阿里云或腾讯云只有2G内存时，可以增加Swap内存</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dd if=/dev/zero of=/swapfile bs=1k count=4816000
mkswap /swapfile
swapon /swapfile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>修改docker-compose,设置内存上限和swap内存</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: '2.3'
services:
  gitlab:
    image: 'gitlab/gitlab-ce:14.0.6-ce.0'
    container_name: gitlab
    restart: always
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://192.168.213.204:8929' #若有域名可以写域名
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
        puma['per_worker_max_memory_mb'] = 256 #更改内存限制设置
        gitlab_rails['time_zone'] = 'Asia/Shanghai'
        puma['worker_processes'] = 2
    ports:
      - '8929:8929'
      - '2224:22'
    volumes:
      #将相关配置映射到当前目录下的config目录
      - './config:/etc/gitlab'
      #将日志映射到当前目录下的logs目录
      - './logs:/var/log/gitlab'
      #将数据映射到当前目录下的data目录
      - './data:/var/opt/gitlab'
    mem_limit: 1024m
    memswap_limit: 4000m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="部署jenkins"><a href="#部署jenkins" class="header-anchor">#</a> 部署Jenkins</h2> <p>由于原生镜像没有安装maven，故我们重新写一个Dockerfile生成镜像</p> <p>Dockerfile</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM jenkins/jenkins:2.303-centos7
USER root
RUN yum install -y maven
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>执行命令生成 镜像</p> <p>cd 到dockerfiel文件目录下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker build -t jenkins/jenkins:2.303-centos7-mvn ./
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用docker-compose.yml便可，docker目录挂载是为了在容器中使用docker命令</p> <p>访问地址：http://192.168.213.204:7080</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: '3'
services:
  jenkins:
    image: 'jenkins/jenkins:2.303-centos7-mvn'
    container_name: jenkins
    restart: always
    user: root
    ports:
      - '7080:8080'
      - '7050:50000'
    volumes:
      - './jenkins_home:/var/jenkins_home'
      - '/var/run/docker.sock:/var/run/docker.sock'
      - '/usr/bin/docker:/usr/bin/docker'
    extra_hosts: 
      - &quot;apiserver.k8s.com:192.168.213.201&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>登录密码：在服务启动后，查看jenkins_home/secrets/initialAdminPassword文件</p> <h2 id="docker配置harbor"><a href="#docker配置harbor" class="header-anchor">#</a> Docker配置Harbor</h2> <p>201到204服务器均修改</p> <h3 id="修改docker-service"><a href="#修改docker-service" class="header-anchor">#</a> 修改docker.service</h3> <p>修改/etc/systemd/system/docker.service</p> <p>将ExecStart=/usr/bin/dockerd改为</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ExecStart=/usr/bin/dockerd --insecure-registry 192.168.213.204:20480
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image-26.55c6f5cd.png" alt=""></p> <h3 id="重启docker"><a href="#重启docker" class="header-anchor">#</a> 重启docker</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload
systemctl restart docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="登录docker"><a href="#登录docker" class="header-anchor">#</a> 登录docker</h3> <p>docker login 192.168.213.204:20480
输入账号密码
账号：admin
密码：Harbor12345</p> <h3 id="上传镜像"><a href="#上传镜像" class="header-anchor">#</a> 上传镜像</h3> <p>先在Harbor中创建项目，例：imdemo</p> <p>将本地镜像打标签，并上传</p> <p>例：本地镜像原标签imtest:2.11.12</p> <p>docker tag imtest:2.11.12 192.168.213.204:20480/imdemo/imtesth:2.11.12</p> <p>推送镜像</p> <p>docker push 192.168.213.204:20480/imdemo/imtesth:2.11.12</p> <h2 id="初始化jenkins"><a href="#初始化jenkins" class="header-anchor">#</a> 初始化Jenkins</h2> <p>使用管理员账号登录后，修改管理员信息：</p> <p>登录名：wuxiaoku
账号：admin
密码：Wuxiaoku123</p> <h3 id="安装推荐的插件及账号"><a href="#安装推荐的插件及账号" class="header-anchor">#</a> 安装推荐的插件及账号</h3> <p><img src="/assets/img/image-28.dda6936f.png" alt=""></p> <p>设置账号，更新密码,填写邮件地址，此处用户名为昵称，登录时使用admin</p> <p><img src="/assets/img/image-29-1024x874.ec365602.png" alt=""></p> <h3 id="安装其他插件"><a href="#安装其他插件" class="header-anchor">#</a> 安装其他插件</h3> <p>打开  “系统管理” =》“管理插件” 然后安装</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Kubernetes Continuous Deploy
Kubernetes
Gitlab Hook 
GitLab
Build Authorization Token
Maven Repository Server
Maven Integration
Publish Over SSH
Docker plugin
SSH Pipeline Steps
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>点击安装</p> <p><img src="/assets/img/image-34.6eb19525.png" alt=""></p> <h2 id="初始化harbor"><a href="#初始化harbor" class="header-anchor">#</a> 初始化Harbor</h2> <h3 id="创建用户"><a href="#创建用户" class="header-anchor">#</a> 创建用户</h3> <p>帐号：wuxiaoku
密码：Wuxiaoku123</p> <p><img src="/assets/img/image-2-1024x434.4a56d7f6.png" alt=""></p> <h3 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h3> <p><img src="/assets/img/image-3-1024x390.00669e8a.png" alt=""></p> <h3 id="增加成员"><a href="#增加成员" class="header-anchor">#</a> 增加成员</h3> <p>点击进去项目</p> <p><img src="/assets/img/image-4-1024x375.d6f321a8.png" alt=""></p> <h2 id="初始化gitlab"><a href="#初始化gitlab" class="header-anchor">#</a> 初始化GitLab</h2> <p>使用管理员账号登录后，新增账号：</p> <p>账号：wuxiaoku
密码：Wuxiaoku123</p> <h3 id="创建账号"><a href="#创建账号" class="header-anchor">#</a> 创建账号</h3> <p><img src="/assets/img/image-31-1024x498.4f455447.png" alt=""></p> <h3 id="初始化密码"><a href="#初始化密码" class="header-anchor">#</a> 初始化密码</h3> <p>在创建完成账号时，密码是不可填写的，在编辑中，初始化一下密码。</p> <p><img src="/assets/img/image-32-1024x413.cee54d74.png" alt=""></p> <h3 id="登录"><a href="#登录" class="header-anchor">#</a> 登录</h3> <p>先重置一下密码，然后保存登录到首页</p> <p><img src="/assets/img/image-33-1024x476.9750f0ea.png" alt=""></p> <h3 id="初始化项目"><a href="#初始化项目" class="header-anchor">#</a> 初始化项目</h3> <h4 id="创建空项目"><a href="#创建空项目" class="header-anchor">#</a> 创建空项目</h4> <p><img src="/assets/img/image-1024x401.27caa4c1.png" alt=""></p> <h4 id="创建dev分支"><a href="#创建dev分支" class="header-anchor">#</a> 创建dev分支</h4> <p><img src="/assets/img/image-36-1024x484.fbcb23a4.png" alt=""></p> <h4 id="提交项目代码"><a href="#提交项目代码" class="header-anchor">#</a> 提交项目代码</h4> <p>提交到dev分支</p> <p>代码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>链接：https://pan.baidu.com/s/1B2-l8Ahfda2qxbvjmWJdhQ 
提取码：sxo4 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/assets/img/image-37-1024x482.faca584e.png" alt=""></p> <h2 id="jenkins配置k8s"><a href="#jenkins配置k8s" class="header-anchor">#</a> Jenkins配置K8S</h2> <h3 id="配置插件"><a href="#配置插件" class="header-anchor">#</a> 配置插件</h3> <p>在jenkins初始化中已经安装了K8S插件，即现在开始配置即可</p> <p>登录jenkins，在首页点击 Manage Jenkins --&gt; Configure System</p> <p>将网页拉动到最底下，点击新增一个云，就会出现Kubernetes</p> <p><img src="/assets/img/image-38-1024x459.40317157.png" alt=""></p> <p><img src="/assets/img/image-39.962a425c.png" alt=""></p> <p>点击配置</p> <p><img src="/assets/img/image-40-1024x378.65a6ece3.png" alt=""></p> <p>填写Kubernetes地址然后点击测试，会报错</p> <p>地址为：https://apiserver.k8s.com:6443</p> <p><img src="/assets/img/image-41-1024x487.9a1c95a3.png" alt=""></p> <p>报错信息：</p> <p><img src="/assets/img/image-42-1024x334.34b2d572.png" alt=""></p> <h4 id="k8s集群信息"><a href="#k8s集群信息" class="header-anchor">#</a> k8s集群信息</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>[root@k8s-master ~]# kubectl cluster-info
Kubernetes master is running at https://apiserver.k8s.com:6443
KubeDNS is running at https://apiserver.k8s.com:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://apiserver.k8s.com:6443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="/assets/img/image-43-1024x121.2c91a001.png" alt=""></p> <p>根据以上的配置，可以看到，已经是启用https了，这里就涉及到了密钥的问题。</p> <h3 id="创建admin证书"><a href="#创建admin证书" class="header-anchor">#</a> 创建admin证书</h3> <h4 id="安装证书工具"><a href="#安装证书工具" class="header-anchor">#</a> 安装证书工具</h4> <p>安装cfssl<br>
此工具生成证书非常方便, pem证书与crt证书,编码一致可直接使用</p> <p>登录k8s master节点执行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
chmod +x cfssl_linux-amd64
mv cfssl_linux-amd64 /usr/local/bin/cfssl

wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
chmod +x cfssljson_linux-amd64
mv cfssljson_linux-amd64 /usr/local/bin/cfssljson

wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x cfssl-certinfo_linux-amd64
mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="准备证书签名请求"><a href="#准备证书签名请求" class="header-anchor">#</a> 准备证书签名请求</h4> <p>vi admin-csr.json</p> <p>内容如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;HangZhou&quot;,
      &quot;L&quot;: &quot;XS&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>证书请求中的O 指定该证书的 Group 为 system:masters</p> <p>而 RBAC 预定义的 ClusterRoleBinding 将 Group system:masters 与 ClusterRole cluster-admin 绑定，这就赋予了该证书具有所有集群权限 。</p> <h4 id="创建证书和私钥"><a href="#创建证书和私钥" class="header-anchor">#</a> 创建证书和私钥</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>cfssl gencert -ca=/etc/kubernetes/pki/ca.crt -ca-key=/etc/kubernetes/pki/ca.key --profile=kubernetes admin-csr.json | cfssljson -bare admin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最终生成以下3个文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>admin.csr
admin-key.pem
admin.pem
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="配置证书"><a href="#配置证书" class="header-anchor">#</a> 配置证书</h4> <h5 id="生成pkc格式证书"><a href="#生成pkc格式证书" class="header-anchor">#</a> 生成pkc格式证书</h5> <p>我们可以通过openssl来转换成pkc格式</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>openssl pkcs12 -export -out ./jenkins-admin.pfx -inkey ./admin-key.pem -in ./admin.pem -passout pass:secret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将jenkins-admin.pfx 下载至桌面</p> <h3 id="配置jenkins认证"><a href="#配置jenkins认证" class="header-anchor">#</a> 配置jenkins认证</h3> <h4 id="kubernetes-服务证书-key"><a href="#kubernetes-服务证书-key" class="header-anchor">#</a> Kubernetes 服务证书 key</h4> <p>使用以下命令查看</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>root@k8s-master:~# cat /etc/kubernetes/pki/ca.crt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将证书内容填写，点击凭据后面的添加，点击Jenkins</p> <p><img src="/assets/img/image-45.ccd7d693.png" alt=""></p> <p>得到<code>jenkins-admin.pfk</code>文件后，点击Jenkins配置Credentials后面的Add，配置如下</p> <p>上传证书</p> <p><img src="/assets/img/image-47-1024x495.a289a7e8.png" alt=""></p> <p>选择文件 jenkins-admin.pfk</p> <p>输入密码 secret，后面的内容可以不填写，点击添加。</p> <p><img src="/assets/img/image-48.a2b1eccc.png" alt=""></p> <p>选择 凭据，点击连接测试。</p> <p>出现Connected to Kubernetes v1.17.1 表示连接成功。</p> <p><img src="/assets/img/image-49-1024x110.dba67279.png" alt=""></p> <p>点击保存</p> <p><img src="/assets/img/image-44-1024x496.39fb4279.png" alt=""></p> <h2 id="gitlab-jenkins配置"><a href="#gitlab-jenkins配置" class="header-anchor">#</a> GitLab+Jenkins配置</h2> <h3 id="gitlab与jenkins配置"><a href="#gitlab与jenkins配置" class="header-anchor">#</a> GitLab与Jenkins配置</h3> <h4 id="设置jenkins-用户ssh秘钥"><a href="#设置jenkins-用户ssh秘钥" class="header-anchor">#</a> 设置jenkins 用户ssh秘钥</h4> <p>使用Root登录GitLab，点击用户名称</p> <p><img src="/assets/img/image-1-1024x333.146d06a1.png" alt=""></p> <p>点击 Impersonate ，表示冒充jenkins 用户</p> <p><img src="/assets/img/image-2-1024x403.0450ded9.png" alt=""></p> <p>点击编辑</p> <p><img src="/assets/img/image-3-1024x253.68c51cd9.png" alt=""></p> <p>点击 ssh keys</p> <p><img src="/assets/img/image-4.6db99958.png" alt=""></p> <p>登录到jenkins服务器（204），生成秘钥</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ssh-keygen -t rsa -P &quot;&quot; -f ~/.ssh/id_rsa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看公钥</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cat /root/.ssh/id_rsa.pub
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将公钥内容复制到网页，点击添加秘钥</p> <p><img src="/assets/img/image-6-1024x356.1e65b03c.png" alt=""></p> <h4 id="创建access-tokens"><a href="#创建access-tokens" class="header-anchor">#</a> 创建Access Tokens</h4> <p>点击左侧的Access Tokens，输入用户 wuxiaoku，勾选权限，点击创建</p> <p><img src="/assets/img/image-12-1024x491.52a04278.png" alt=""></p> <p>复制token，待会 jenkins 设置时，会用到</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>MXMnxpwMLAgiP9zyS5dp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image-13-1024x340.295d6ee3.png" alt=""></p> <p>点击进入你的项目</p> <p><img src="/assets/img/image-14.e1a54dd2.png" alt=""></p> <p>点击项目</p> <p><img src="/assets/img/image-15.149eb4b4.png" alt=""></p> <p>点击设置-成员</p> <p><img src="/assets/img/image-11-1024x393.fb517ced.png" alt=""></p> <p>把管理员也添加进去，这样管理员也有权限了。如果项目一开始是管理员创建，这时就选择子用户</p> <p><img src="/assets/img/image-17-1024x479.b1e1cf44.png" alt=""></p> <h3 id="jenkins配置git-gitlab"><a href="#jenkins配置git-gitlab" class="header-anchor">#</a> Jenkins配置Git/GitLab</h3> <h4 id="jenkins配置gitlab"><a href="#jenkins配置gitlab" class="header-anchor">#</a> Jenkins配置GitLab</h4> <p>点击 系统管理--&gt; 系统配置 --&gt;配置 --&gt;Gitlab</p> <p><img src="/assets/img/image-18.d5de7868.png" alt=""></p> <p>Connection Name ”随便填，“Git Host URL”填GitLab的访问地址，然后点“Add”——“jenkins”，如下所示</p> <p><img src="/assets/img/image-19.2032f737.png" alt=""></p> <p>选择gitlalb api，输入 jenkins 用户创建的token</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>MXMnxpwMLAgiP9zyS5dp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image-20-1024x480.10c30415.png" alt=""></p> <p>选择 gitlab api token，点击测试连接，出现 Success，表示成功</p> <p><img src="/assets/img/image-21-1024x165.a3db1ec4.png" alt=""></p> <p>点击最下面的保存</p> <p><img src="/assets/img/image-23-1024x359.1a77f1d3.png" alt=""></p> <h4 id="jenkins配置git"><a href="#jenkins配置git" class="header-anchor">#</a> Jenkins配置Git</h4> <p>点击 Manage Jenkins --&gt; Configure System --&gt;配置 --&gt;Git plugin</p> <p><img src="/assets/img/image-24.c9069d42.png" alt=""></p> <p>设置Git插件的全局配置，然后点击最下面的保存。</p> <p><img src="/assets/img/image-25.23b191dc.png" alt=""></p> <h3 id="创建一个jenkins-job"><a href="#创建一个jenkins-job" class="header-anchor">#</a> 创建一个Jenkins Job</h3> <p>此处创建用于测试是否正常使用</p> <p>点击 新建Item，item name”可以随便起，然后点击“构建一个自由风格的软件项目”，点击Ok</p> <p><img src="/assets/img/image-26-1024x701.7bdafa8f.png" alt=""></p> <h4 id="配置job的源码管理"><a href="#配置job的源码管理" class="header-anchor">#</a> 配置Job的源码管理</h4> <p>选择“源码管理”，选择“Git”,然后去GitLab中复制项目地址，粘贴到“Repository URL”,然后点击“credentials”后面的“Add”按钮</p> <p><img src="/assets/img/image-31-1024x447.9b41f1e2.png" alt=""></p> <p>类型，选择 SSH Username with private key</p> <p>Username 填 root</p> <p>PrivateKey 选择Enter directly，点击add</p> <p><img src="/assets/img/image-28-1024x478.318fbf99.png" alt=""></p> <p>登录到jenkins 服务器，查看私钥</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cat /root/.ssh/id_rsa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将内容复制到网页上面，点击添加</p> <p><img src="/assets/img/image-29-1024x479.07e3431c.png" alt=""></p> <p>在“credentials”里选择我们刚刚创建的认证方式：root</p> <p><img src="/assets/img/image-30-1024x160.b1863ea1.png" alt=""></p> <p>如果没报错，说明成功了，点击页面底部的“apply”。如果出错了，会在“Repository URL”和“Credentials”之间显示红色的错误信息。</p> <p>jenkins job默认对master分支进行构建，你也可以自定义分支。这要求你的Gitlab代码仓库中要存在这个分支，一般来说，就是要向代码仓库提交一次更改，请 自行完成（Gitlab项目刚创建时是空的，一个分支也没有，这样的话，自动构建时会出错）</p> <p>我们上文创建了dev分钟，故选择dev</p> <p><img src="/assets/img/image-32-1024x290.981054b3.png" alt=""></p> <h4 id="配置job的构建触发器"><a href="#配置job的构建触发器" class="header-anchor">#</a> 配置Job的构建触发器</h4> <p>选择“构建触发器”，勾选“Pull SCM（轮询 SCM）”，这个选项会每隔一段时间检查一下GitLab仓库中代码是否有更新，有的话就执行构建操作。日程表如何设置，在这个输入框下面有说明</p> <p><img src="/assets/img/image-33-1024x324.6f70e126.png" alt=""></p> <p>扩展阅读：</p> <p>常见构建触发器：</p> <ul><li>Build after other projects are built 当另一个构建任务完成之后触发</li> <li>Build periodically 周期性的触发</li> <li>Build when a change is pushed to GitLab. GitLab CI Service URL: http://191.8.2.112:12000/project/test-go-dev 当代码有更新的时候触发，通过GitLab CI</li> <li>GitHub hook trigger for GITScm polling 通过Github钩子触发</li> <li>Poll SCM 定期检查代码有无更新，有更新时触发</li></ul> <p>这只是个人理解，具体怎么样大家可以试试，Poll SCM方式我是试过的。</p> <h4 id="配置job的构建脚本"><a href="#配置job的构建脚本" class="header-anchor">#</a> 配置Job的构建脚本</h4> <p>在build栏目里，选择“jenkins execute shell”,然后输入你项目的构建命令（这依赖于你的项目，如Maven的maven build，gulp的gulp xxx 等等）</p> <p><img src="/assets/img/image-34.6eb19525.png" alt=""></p> <p>这里我输入一段测试命令，表示将git项目的代码复制到/tmp/test</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>\cp -r $WORKSPACE /tmp/test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>点击 可用的环境变量列表，就可以看到很多变量</p> <p><img src="/assets/img/image-35.2b401510.png" alt=""></p> <p>其中 WORKSPACE 表示，下载git项目后的路径。</p> <p>由于git项目为itest，因此路径为：/var/lib/jenkins/workspace/itest</p> <p>点击保存</p> <p>点击 立即构建，点击下面的构建过程</p> <p><img src="/assets/img/image-37.b90c3881.png" alt=""></p> <p>点击控制台输出，就可以看到完整的cp命令</p> <p><img src="/assets/img/image-38-1024x454.20b5d93b.png" alt=""></p> <h2 id="jenkins配置maven"><a href="#jenkins配置maven" class="header-anchor">#</a> Jenkins配置maven</h2> <p>我们在生成镜像时已经安装了maven，故这边只要配置即可</p> <h3 id="查看java和maven安装地址"><a href="#查看java和maven安装地址" class="header-anchor">#</a> 查看java和maven安装地址</h3> <p>登录jenkins服务器204</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker exec -it jenkins /bin/sh
mvn -version

Apache Maven 3.0.5 (Red Hat 3.0.5-17)
Maven home: /usr/share/maven
Java version: 1.8.0\_292, vendor: AdoptOpenJDK
Java home: /usr/lib/jvm/adoptopenjdk-8-hotspot/jre
Default locale: en\_US, platform encoding: ANSI\_X3.4-1968
OS name: &quot;linux&quot;, version: &quot;3.10.0-1160.el7.x86\_64&quot;, arch: &quot;amd64&quot;, family: &quot;unix&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="/assets/img/image-41.51afda83.png" alt=""></p> <h3 id="新增jdk"><a href="#新增jdk" class="header-anchor">#</a> 新增JDK</h3> <p>登录到Jenkins管理后台，点击 Manage Jenkins --&gt; Global Tool Configuration</p> <p><img src="/assets/img/image-39-1024x410.2a154bdc.png" alt=""></p> <p>点击 新增jdk</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAx0AAAC5CAYAAABN/FL2AAAbLklEQVR4Ae3dz4sc550H4PxPdZqDwBAw+KCT5mKBIGYPawJqMEQYLHKwWQjKpZmDcHDQBmGWXSWH9ITECmt8cCKD0RKGDhhsWOywMBA5EwwCkwwIvsvb9aOrqqtHPWN1d9X0MyCmuvqtet963hK8n3nrx/ei4+frb552rLWKAAECBAgQIECAAAEC5xf4XtcmQkeXinUECBAgQIAAAQIECFxEQOi4iJptCBAgQIAAAQIECBBYWUDoWJlKQQIECBAgQIAAAQIELiIgdFxEzTYECBAgQIAAAQIECKwsIHSsTKUgAQIECBAgQIAAAQIXERA6LqJmGwIECBAgQIAAAQIEVhYQOlamUpAAAQIECBAgQIAAgYsICB0XUbMNAQIECBAgQIAAAQIrCwgdK1MpSIAAAQIECBAgQIDARQSEjouo2YYAAQIECBAgQIAAgZUFhI6VqRQkQIAAAQIECBAgQOAiAkLHRdRsQ4AAAQIECBAgQIDAygJCx8pUChIgQIAAAQIECBAgcBEBoeMiarYhQIAAAQIECBAgQGBlAaFjZSoFCRAgQIAAAQIECBC4iIDQcRE12xAgQIAAAQIECBAgsLLABkLHNMZZFlmWxfio1q6j8WxdWl//t/fK9bj+ozvx/uE0Tp7VyleLS/aXvn92HJOb+f723pjEcef21Y4sECBAgAABAgQIECCwAYHehY56AMmuXI/xJycthmWh4zSmB/t5gLk2jum3rc18JECAAAECBAgQIEBgKwI9CB3jmNYP/fRpHB89iHde3StmQPZjfHRaK9EdOo4PR7GXZk2ujGJyXCtukQABAgQIECBAgACBrQr0L3SUHM+O40FxqVR27V58Xl0q1RE6vrgX+7PLtNoBpdyZ3wQIECBAgAABAgQIbEugv6EjiXx2L67OwsTVuPdFSdQKHd9OY3wt3cexF6NDUxylkt8ECBAgQIAAAQIE+iLQ79AR84AxOizv7ZivG//PcUzeyC/D2j+YRv0irL4AawcBAgQIECBAgACBXRfoeeg4qZ5G1RU6XvvBa/l9H//6wJOqdv1MdvwECBAgQIAAAQK9Feh56PgyHtzIH4HbFTreORi7l6O3p5aGESBAgAABAgQIEMgFNhg69uLun2vs1Xs6Wk+vqhWJ00dxp3iPx51PyounapdXHUV8/u/FY3I9taouZ5kAAQIECBAgQIBAbwTWHzqq4DCKyZPaca8QOk4/uZM/Bje7FQ+/Kbdtho7ZCwGL+zoy7+cokfwmQIAAAQIECBAg0BuB9YeO6glUd+JROVmRDv95oePkUdy5ml9atf9u/SbxVuhI+6qeYJWFN5H35tzSEAIECBAgQIAAAQIzgfWGjm8eF4+zzWLv7Y/iaR19Wej49jimh+N47UoeOPb+5V583ni7eEfoiIjTP98t7u/IwpOs6tCWCRAgQIAAAQIECGxXYA2hY/7Eqay4H6PzLeFV6MjDRVW23Cbbi+v/NokvG4EjYXWHjvRN9VZy7+zY7lmldgIECBAgQIAAAQI1gbWEjodv5u/OyK68HK/9+P14XL5io1bx/PKqeujYi5dffT1uvzuJx1815kVqWy4PHRGnMT0obizPvJ28hmaRAAECBAgQIECAwNYE1hA6tnYsKiZAgAABAgQIECBAoIcCQkcPO0WTCBAgQIAAAQIECFwmAaHjMvWmYyFAgAABAgQIECDQQwGho4edokkECBAgQIAAAQIELpOA0HGZetOxECBAgAABAgQIEOihgNDRw07RJAIECBAgQIAAAQKXSUDouEy96VgIECBAgAABAgQI9FBgLaHjL3/5S/jHwDngHHAOOAecA84B54BzwDngHEjnwFpCRw/DlSYRIECAAAECBAgQILAlAaFjS/CqJUCAAAECBAgQILArAkLHrvS04yRAgAABAgQIECCwJQGhY0vwqiVAgAABAgQIECCwKwJCx670tOMkQIAAAQIECBAgsCUBoWNL8KolQIAAAQIECBAgsCsCQseu9LTjJECAAAECBAgQILAlAaFjS/CqJUCAAAECBAgQILArAkLHrvS04yRAgAABAgQIECCwJQGhY0vwqiVAgAABAgQIECCwKwJCx670tOMkQIAAAQIECBAgsCUBoWNL8KolQIAAAQIECBAgsCsCQseu9LTjJECAAAECBAgQILAlAaFjS/CqJUCAAAECBAgQILArAkLHrvS04yRAgAABAgQIECCwJQGhY0vwqiVAgAABAgQIECCwKwJCx670tOMkQIAAAQIECBAgsCWBSxw6pjHORjF5cpZsvcxJTG62y6d1WYyPztqH7wgQIECAAAECBAgQOEtgvaHjySRGWRajw5O8DUfjyLKs9u+l2P/h7Xj/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" alt=""></p> <p>自动安装 前面的勾选，去掉，输入别名和JAVA_HOME</p> <p><img src="/assets/img/image-42-1024x354.9f524aa4.png" alt=""></p> <p>注意：JAVA_HOME的输入框下面，不要有警告或者错误信息，否则就是路径不正确。</p> <p>使用 mvn -version 命令时，就已经打印了Java home变量，注意：去除最后的jre</p> <p><img src="/assets/img/image-43-1024x311.1707c407.png" alt=""></p> <h3 id="新增maven"><a href="#新增maven" class="header-anchor">#</a> 新增Maven</h3> <p>点击新增Maven</p> <p><img src="/assets/img/image-44-1024x398.a698f424.png" alt=""></p> <p>同样去除自动安装，填写别名</p> <p><img src="/assets/img/image-45-1024x448.4e624805.png" alt=""></p> <p>点击保存</p> <h2 id="jenkins使用docker命令"><a href="#jenkins使用docker命令" class="header-anchor">#</a> Jenkins使用docker命令</h2> <p>此处还是为测试任务使用，加深对Jenkins的了解</p> <p>创建流水线任务</p> <p><img src="/assets/img/image-46-1024x634.0e594510.png" alt=""></p> <p>输入pipeline脚本，点击保存</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>pipeline {
    agent any
    stages {
        stage('Test') {
            steps {
                sh 'docker images'
            }
        }
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="/assets/img/image-47-1024x498.25a04dde.png" alt=""></p> <p>立即构建，查看控制台</p> <p><img src="/assets/img/image-48-1024x644.5f4896f7.png" alt=""></p> <h2 id="jenkins-harbor-gitlab-k8s"><a href="#jenkins-harbor-gitlab-k8s" class="header-anchor">#</a> Jenkins+Harbor+GitLab+K8S</h2> <h3 id="方式一"><a href="#方式一" class="header-anchor">#</a> 方式一</h3> <p>缺点：对K8S脚本generateyaml.sh创建模板较死板，我是随便摸索写的测试<br>
个人喜欢方式二</p> <h4 id="k8s创建命名空间"><a href="#k8s创建命名空间" class="header-anchor">#</a> K8S创建命名空间</h4> <p>登录Kuboard创建命名空间：imtest</p> <p><img src="/assets/img/image-53-1024x318.1c29846c.png" alt=""></p> <h4 id="k8s创建harbor密码信息"><a href="#k8s创建harbor密码信息" class="header-anchor">#</a> K8S创建Harbor密码信息</h4> <p>输入Harbor之前创建的账号密码</p> <p><img src="/assets/img/image-54-1024x383.35e22a53.png" alt=""></p> <h4 id="工程新建脚本"><a href="#工程新建脚本" class="header-anchor">#</a> 工程新建脚本</h4> <p>将脚本放在工程根目录下</p> <p>脚本：</p> <p>链接：https://pan.baidu.com/s/1Z73E8sBq9TqYR2sEWiFeZg
提取码：pkrg</p> <p>目录结构如下</p> <p><img src="/assets/img/image-52.c758ca22.png" alt=""></p> <h4 id="jenkins创建任务"><a href="#jenkins创建任务" class="header-anchor">#</a> Jenkins创建任务</h4> <p>新建流水线任务：imtest1</p> <p><img src="/assets/img/image-56-1024x456.fc6093b3.png" alt=""></p> <p>构建触发器</p> <p>*/1 * * * *</p> <p><img src="/assets/img/image-57-1024x493.ab1bef1c.png" alt=""></p> <p>流水线</p> <p><img src="/assets/img/image-58-1024x578.eb1729d8.png" alt=""></p> <p>点击保存</p> <p>立即构建-查看日志，第一次会报错。</p> <p><img src="/assets/img/image-60-1024x493.b4bbef3a.png" alt=""></p> <p>进入201服务器，执行命令</p> <p>kubectl apply -f /root/data/app/imdemo.yaml</p> <p><img src="/assets/img/image-61.73e6443b.png" alt=""></p> <p>Jenkins再次构建就成功了，后续代码提交自动构建</p> <p><img src="/assets/img/image-62-1024x418.969d50bc.png" alt=""></p> <h3 id="方式二"><a href="#方式二" class="header-anchor">#</a> 方式二</h3> <p>缺点：需要先去创建一次pod<br>
优点：自由配置pod</p> <h4 id="k8s创建命名空间-2"><a href="#k8s创建命名空间-2" class="header-anchor">#</a> K8S创建命名空间</h4> <p>登录Kuboard创建命名空间：imtest</p> <p><img src="/assets/img/image-53-1024x318.1c29846c.png" alt=""></p> <h4 id="k8s创建harbor密码信息-2"><a href="#k8s创建harbor密码信息-2" class="header-anchor">#</a> K8S创建Harbor密码信息</h4> <p>输入Harbor之前创建的账号密码</p> <p><img src="/assets/img/image-54-1024x383.35e22a53.png" alt=""></p> <p>地址要用http://ip:端口</p> <p><img src="/assets/img/image-1-1024x598.c091eff5.png" alt=""></p> <h4 id="工程新建脚本-2"><a href="#工程新建脚本-2" class="header-anchor">#</a> 工程新建脚本</h4> <p>地址：</p> <p>链接：https://pan.baidu.com/s/1gTttHuYcQgCZUIqmQBjIEQ
提取码：77rh</p> <p>目录结构如下</p> <p><img src="/assets/img/image-63.2065fc62.png" alt=""></p> <h4 id="jenkins创建任务-2"><a href="#jenkins创建任务-2" class="header-anchor">#</a> Jenkins创建任务</h4> <p>新建流水线任务：imtest1</p> <p><img src="/assets/img/image-56-1024x456.fc6093b3.png" alt=""></p> <p>构建触发器</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>*/1 * * * *
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image-57-1024x493.ab1bef1c.png" alt=""></p> <p>流水线</p> <p><img src="/assets/img/image-58-1024x578.eb1729d8.png" alt=""></p> <p>点击保存</p> <p>立即构建-查看日志，第一次会报错。</p> <p><img src="/assets/img/image-64-1024x788.4db6144e.png" alt=""></p> <h4 id="k8s创建pod"><a href="#k8s创建pod" class="header-anchor">#</a> K8S创建Pod</h4> <p>如图所示，创建服务名称imdemo</p> <p><img src="/assets/img/image-65-1024x486.4c7b018c.png" alt=""></p> <p>点击保存</p> <p><img src="/assets/img/image-66-1024x462.5496b423.png" alt=""></p> <p>创建完成</p> <p><img src="/assets/img/image-67-1024x483.ef96b2d0.png" alt=""></p> <p>查看CI/CD集成，复制到剪切板</p> <p><img src="/assets/img/image-70-1024x476.c5632b95.png" alt=""></p> <p>修改Jenkinsfile</p> <p>将复制的内容替换掉红色方块内容</p> <p><img src="/assets/img/image-71-1024x340.4f20c4e1.png" alt=""></p> <p>代码提交自动构建成功</p> <p><img src="/assets/img/image-68-1024x468.a00c4acb.png" alt=""></p> <p>缺陷：后续需要修改的地方</p> <p>Jenkinsfile文件中镜像版本每次提交需要修改变化，这4个地方</p> <p><img src="/assets/img/image-73-1024x437.c985ee5a.png" alt=""></p> <p>修复缺陷，每次提交不用再修改上文4个标红的地方，使用$BUILD_ID代替</p> <p>Jenkinsfile</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>pipeline {
    agent any
    stages {
        stage('package') {
            steps {
                sh 'mvn clean package'
            }
        }
        stage('buildDockerImages') {
            steps {
                sh 'docker login 192.168.213.204:20480 -u wuxiaoku -p Wuxiaoku123'
                sh 'docker build --build-arg app=imdemo.jar -t 192.168.213.204:20480/kudemo/imdemo:$BUILD_ID .'
                sh 'docker push 192.168.213.204:20480/kudemo/imdemo:$BUILD_ID'
                sh 'docker rmi 192.168.213.204:20480/kudemo/imdemo:$BUILD_ID'
            }
        }
        stage('deploymentK8S'){
             steps {
                 sh &quot;&quot;&quot;
                     curl -X PATCH \
                     -H &quot;content-type: application/strategic-merge-patch+json&quot; \
                     -H &quot;Authorization:Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Ikl1SGVIeVY3TEdEeFZ1b3Z4QzU5eEFmU2pacGtVWGlRTHpIQ3hBR3V5NTQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJvYXJkLXVzZXItdG9rZW4tcm1zcHoiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoia3Vib2FyZC11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTE0ZWVlYjUtMmZiOS00YzZmLTg1YzUtZjYzOWFiODZlODJjIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmt1Ym9hcmQtdXNlciJ9.K7h7UrtDcsUNy2GYTznloOPZiWML0ll_zEhd1fUaY0pioTQ-MEPgDdp6rRnZmUm7ujNM_zsjzhS4KTbezSV-1Od0O-yhQrTyrqpvcXBi_EP77s9nDueZ_4fMx76Eh-cZfsOPQxYtG0sufqZmqcM1DWzNHDQcBMmFy1nhDbPncnmiirNrEBSFfrVb-ie6Z33Ip61tZjkYvrW6PeVHXEagTjrHnjmO9zw_L8to9V4pE990vcQrJE3f5pUN94k7JD5EhlJT0j1ljPrhRbpL8m-KjLpypKqfq9i7mj3vXE9_1mEVSi78nGuyR2cBaCLPoV7C3HRUN_dvCdR1tcI6nOLT2Q&quot; \
                     -d '{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;imdemo&quot;,&quot;image&quot;:&quot;192.168.213.204:20480/kudemo/imdemo:$BUILD_ID&quot;}]}}}}' \
                     &quot;http://192.168.213.201:32567/k8s-api/apis/apps/v1/namespaces/imtest/deployments/web-imdemo&quot;
                 &quot;&quot;&quot;
             }
        }
    
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>参考博客部分内容：<br>
https://www.jianshu.com/p/fd9f1076ea2d<br>
https://www.cnblogs.com/xiao987334176/p/11434849.html</p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/14, 05:49:29</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/bb3405/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Prometheus部署及使用</div></a> <a href="/pages/c5c5bb/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">K8S-在线安装</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/bb3405/" class="prev">Prometheus部署及使用</a></span> <span class="next"><a href="/pages/c5c5bb/">K8S-在线安装</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer">
     Copyright © 2019-2023
    <span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.68b6bd65.js" defer></script><script src="/assets/js/4.b460a2fa.js" defer></script><script src="/assets/js/6.d822d7aa.js" defer></script><script src="/assets/js/3.1b6344a7.js" defer></script>
  </body>
</html>
